name: Documentation Review

on:
  schedule:
    - cron: "0 9 * * 3"  # Every Wednesday at 9AM UTC
  pull_request:
    paths:
      - "**.md"
      - "financial-report-insights/**/*.py"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  doc-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log age check

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run documentation review
        id: review
        run: python .github/scripts/doc_review.py

      - name: Post PR comment (on pull_request)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = 'Documentation review completed.';
            try {
              body = fs.readFileSync('.github/metrics/doc-report.md', 'utf8');
            } catch (e) {}

            body += '\n\n*Auto-generated by doc-review workflow*';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('# Documentation Health Report'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Close previous doc-health issues
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'doc-health',
              per_page: 10,
            });
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
            }

      - name: Create doc-health issue (scheduled only)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = 'Documentation review completed.';
            try {
              body = fs.readFileSync('.github/metrics/doc-report.md', 'utf8');
            } catch (e) {}

            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Docs] Documentation health report - ${date}`,
              body: body + '\n\n*Auto-generated by doc-review workflow*',
              labels: ['doc-health'],
            });
