name: Repository Health

on:
  schedule:
    - cron: "0 9 * * 1"  # Every Monday at 9AM UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install audit tools
        run: pip install pip-audit

      - name: Run health check
        id: health
        run: python .github/scripts/health_check.py

      - name: Close previous health issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'repo-health',
              per_page: 10,
            });
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
            }

      - name: Create health report issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = 'Health check completed. See workflow logs for details.';
            try {
              body = fs.readFileSync('.github/metrics/health-report.md', 'utf8');
            } catch (e) {}

            const labels = ['repo-health'];
            const hasCritical = '${{ steps.health.outputs.has_critical }}' === 'true';
            if (hasCritical) labels.push('needs-attention');

            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Health] Repository health report - ${date}`,
              body: body + '\n\n*Auto-generated by repo-health workflow*',
              labels: labels,
            });

      - name: Commit health metrics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/metrics/health-report.json
          git diff --cached --quiet || git commit -m "metrics: update health report [skip ci]"
          git push || true
