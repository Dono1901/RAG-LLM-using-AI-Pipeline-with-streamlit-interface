name: Metrics Collector

on:
  schedule:
    - cron: "0 10 * * 0"  # Every Sunday at 10AM UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        working-directory: financial-report-insights
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with coverage
        working-directory: financial-report-insights
        run: |
          python -m pytest tests/ -q --tb=no --cov=. --cov-report=xml || true

      - name: Collect metrics
        id: metrics
        run: python .github/scripts/metrics_collector.py

      - name: Commit updated metrics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/metrics/history.json
          git diff --cached --quiet || git commit -m "metrics: weekly metrics collection [skip ci]"
          git push || true

      - name: Create regression issue if needed
        if: steps.metrics.outputs.has_regressions == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let details = '';
            try {
              const data = JSON.parse(fs.readFileSync('.github/metrics/regressions.json', 'utf8'));
              details = data.regressions.map(r => `- ${r}`).join('\n');
            } catch (e) { details = 'See workflow logs for details.'; }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Regression] Weekly metrics regression - ${new Date().toISOString().split('T')[0]}`,
              body: `## Metrics Regression Detected\n\n${details}\n\n*Auto-generated by metrics-collector workflow*`,
              labels: ['regression', 'needs-attention'],
            });
